function [dcmdirS] = scandir_mldcm(path, hWaitbar, dirNum)
%"scandir_mldcm"
%   Scans a passed directory for DICOM files, checking each file in the
%   directory for properly formatted DICOM regardless of file extension.
%   Builds an output struct containing info on each DICOM file found,
%   including filename, filetype, patient name etc.
%
%   An optional waitbar handle can be passed if a graphical representation
%   of progress is desired.

%
%JRA 6/1/06
%YWU Modified 03/01/08
%
%Usage:
%   infoS = scandir_mldcm(directoryName, hWaitbar)
%
% Copyright 2010, Joseph O. Deasy, on behalf of the CERR development team.
% 
% This file is part of The Computational Environment for Radiotherapy Research (CERR).
% 
% CERR development has been led by:  Aditya Apte, Divya Khullar, James Alaly, and Joseph O. Deasy.
% 
% CERR has been financially supported by the US National Institutes of Health under multiple grants.
% 
% CERR is distributed under the terms of the Lesser GNU Public License. 
% 
%     This version of CERR is free software: you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation, either version 3 of the License, or
%     (at your option) any later version.
% 
% CERR is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
% without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
% See the GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with CERR.  If not, see <http://www.gnu.org/licenses/>.

%Check that path is a string

switch lower(class(path))
    case 'char'
    otherwise
        error('Input to scandir_mldcm must be a string.');
end

%Check that it's a real path.
if ~isdir(path)
    error('Input to scandir_mldcm must be a directory.');
end

if ispc
    %Get directory contents
    filesV = dir([path '\*.*']);
else
    filesV = dir([path '/*.*']);
    filesV = dir([path '/*.*']);
end

%Remove directories from the fileList.
filesV([filesV.isdir]) = [];

%Scan each file, returning
dcmdirS = [];

for i=1:length(filesV)

    filename = fullfile(path, filesV(i).name);
    [dcmObj, isDcm] = scanfile_mldcm(filename);

    if isDcm
        dcmdirS = dcmdir_add(filename, dcmObj, dcmdirS);
        %         [isValid, errMsg] = validate_patient_module(dcmObj);
        dcmObj.clear;
    end
    [pathstr, name, ext, versn] = fileparts(filename);
    waitbar(i/length(filesV),hWaitbar, ['Scanning Directory ' num2str(dirNum) ' Please wait...']);
    %['file: ' name ext]});
end
